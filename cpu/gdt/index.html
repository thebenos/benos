<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>GDT - BenOS Documentation</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../css/brands.min.css" rel="stylesheet">
        <link href="../../css/solid.min.css" rel="stylesheet">
        <link href="../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">BenOS Documentation</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href="../.." class="nav-link">Home</a>
                            </li>
                            <li class="nav-item">
                                <a href="../../download/" class="nav-link">Download</a>
                            </li>
                            <li class="nav-item">
                                <a href="../../contributing/" class="nav-link">Contributing</a>
                            </li>
                            <li class="nav-item">
                                <a href="../../license/" class="nav-link">License</a>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle active" aria-current="page" role="button" data-bs-toggle="dropdown"  aria-expanded="false">CPU</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="./" class="dropdown-item active" aria-current="page">GDT</a>
</li>
                                    
<li>
    <a href="../interrupts/" class="dropdown-item">Interrupts</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Drivers</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../drivers/ps2kbd/" class="dropdown-item">PS/2 keyboard</a>
</li>
                                    
<li>
    <a href="../../drivers/pic/" class="dropdown-item">PIC</a>
</li>
                                    
<li>
    <a href="../../drivers/pit/" class="dropdown-item">PIT</a>
</li>
                                    
<li>
    <a href="../../drivers/kbd/" class="dropdown-item">Keyboard</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">API</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../api/console/" class="dropdown-item">Console</a>
</li>
                                    
<li>
    <a href="../../api/io/" class="dropdown-item">IO ports</a>
</li>
                                    
<li>
    <a href="../../api/lib/" class="dropdown-item">Kernel library</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../../license/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../interrupts/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#gdt-global-descriptor-table" class="nav-link">GDT – Global Descriptor Table</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#overview" class="nav-link">Overview</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#related-files" class="nav-link">Related files:</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#responsibilities" class="nav-link">Responsibilities</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#initialization-flow" class="nav-link">Initialization flow</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="gdt-global-descriptor-table">GDT – Global Descriptor Table</h1>
<p>This page documents the internal implementation of the GDT setup in BenOS.</p>
<h2 id="overview">Overview</h2>
<p>The GDT is initialized during early kernel boot to setup required segment descriptors in long mode. The segmentation is not really used in long mode, but the GDT is still required for compatibility and TSS loading.</p>
<hr />
<h2 id="related-files">Related files:</h2>
<ul>
<li><a href="https://github.com/thebenos/benos/blob/main/kernel/cpu/include/gdt.h"><code>kernel/cpu/include.gdt.h</code></a></li>
<li><a href="https://github.com/thebenos/benos/blob/main/kernel/cpu/gdt.c"><code>kernel/cpu/gdt.c</code></a></li>
<li><a href="https://github.com/thebenos/benos/blob/main/kernel/asm/gdt_flush.asm"><code>kernel/asm/gdt_flush.asm</code></a></li>
</ul>
<hr />
<h2 id="responsibilities">Responsibilities</h2>
<p>The GDT setup code handles:</p>
<ul>
<li>Declaring and initializing the GDT entries</li>
<li>Installing the GDT</li>
<li>Defining 16, 32 and 64-bit segments for kernel code/data</li>
</ul>
<h2 id="initialization-flow">Initialization flow</h2>
<hr />
<h3 id="1-gdt-structures">1. GDT structures</h3>
<p>The GDT is defined as a static array of descriptors in <code>kernel/cpu/include/gdt.h</code>. A pointer structure named <code>gdt_ptr_t</code> is passed to <code>lgdt</code> to load it in <code>kernel/asm/gdt_flush.asm</code>.</p>
<pre><code class="language-c">// Source: kernel/cpu/include/gdt.h

// The GDT descriptor structure
typedef struct
{
    uint16_t limit_low;
    uint16_t base_low;
    uint8_t base_middle;
    uint8_t access;
    uint8_t granularity;
    uint8_t base_high;
} __attribute__ ((packed)) gdt_entry_t;

// The GDT pointer structure
typedef struct
{
    uint16_t limit;
    uint64_t base;
} __attribute__ ((packed)) gdt_ptr_t;
</code></pre>
<hr />
<h3 id="2-initialization-function">2. Initialization function</h3>
<p><em>NOTE: the functions described below depend of the <code>gdt</code> array.</em></p>
<p>The GDT is initialized using the <code>gdt_init()</code> function declared in <code>kernel/cpu/include/gdt.h</code>. This function is defined in <code>kernel/cpu/gdt.c</code>. First, it sets up the GDT pointer (defined as <code>gdt_ptr</code>) and then, it sets up the GDT entries with the <code>gdt_set_entry()</code> static function defined in <code>kernel/cpu/gdt.c</code> like the following:</p>
<pre><code class="language-c">// Source: kernel/cpu/gdt.c

static void gdt_set_entry(int n, uint32_t base, uint32_t limit, uint8_t access, uint8_t flags)
{
    // function body here
}
</code></pre>
<p><code>gdt_init()</code> sets up the following segments:</p>
<ul>
<li>Null</li>
<li>16-bit code / 16-bit data</li>
<li>32-bit code / 32-bit data</li>
<li>64-bit code / 64-bit data</li>
</ul>
<p>Finally, it flushes the GDT using <code>gdt_flush()</code> defined in <code>kernel/asm/gdt_flush.asm</code>.</p>
<pre><code class="language-nasm">; Source: kernel/asm/gdt_flush.asm

gdt_flush:
    lgdt [rdi]                      ; gdt_ptr is passed to RDI

    mov ax, 0x30
    mov ds, ax
    mov es, ax
    mov fs, ax
    mov gs, ax
    mov ss, ax
    pop rdi

    mov ax, 0x28
    push rax
    push rdi
    retfq

    ret
</code></pre></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
