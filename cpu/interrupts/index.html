<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Interrupts - BenOS Documentation</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../css/brands.min.css" rel="stylesheet">
        <link href="../../css/solid.min.css" rel="stylesheet">
        <link href="../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">BenOS Documentation</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href="../.." class="nav-link">Home</a>
                            </li>
                            <li class="nav-item">
                                <a href="../../download/" class="nav-link">Download</a>
                            </li>
                            <li class="nav-item">
                                <a href="../../contributing/" class="nav-link">Contributing</a>
                            </li>
                            <li class="nav-item">
                                <a href="../../license/" class="nav-link">License</a>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle active" aria-current="page" role="button" data-bs-toggle="dropdown"  aria-expanded="false">CPU</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../gdt/" class="dropdown-item">GDT</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active" aria-current="page">Interrupts</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Drivers</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../drivers/ps2kbd/" class="dropdown-item">PS/2 keyboard</a>
</li>
                                    
<li>
    <a href="../../drivers/pic/" class="dropdown-item">PIC</a>
</li>
                                    
<li>
    <a href="../../drivers/pit/" class="dropdown-item">PIT</a>
</li>
                                    
<li>
    <a href="../../drivers/kbd/" class="dropdown-item">Keyboard</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">API</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../api/console/" class="dropdown-item">Console</a>
</li>
                                    
<li>
    <a href="../../api/io/" class="dropdown-item">IO ports</a>
</li>
                                    
<li>
    <a href="../../api/lib/" class="dropdown-item">Kernel library</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../gdt/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../../drivers/ps2kbd/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#interrupts-idt-and-isrs" class="nav-link">Interrupts – IDT and ISRs</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#overview" class="nav-link">Overview</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#related-files" class="nav-link">Related files</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#responsibilities" class="nav-link">Responsibilities</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#initialization-flow" class="nav-link">Initialization flow</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="interrupts-idt-and-isrs">Interrupts – IDT and ISRs</h1>
<p>This document describes how the Interrupt Descriptor Table (IDT) and Interrupt Service Routines (ISRs) are implemented in BenOS.</p>
<h2 id="overview">Overview</h2>
<p>The IDT is a CPU structure used to handle exceptions, hardware interrupts, and software traps. Each entry in the IDT points to an interrupt or exception handler function (ISR). It is loaded during early kernel initialization.</p>
<hr />
<h2 id="related-files">Related files</h2>
<ul>
<li><a href="https://github.com/thebenos/benos/blob/main/kernel/cpu/include/idt.h"><code>kernel/cpu/include/idt.h</code></a></li>
<li><a href="https://github.com/thebenos/benos/blob/main/kernel/cpu/idt.c"><code>kernel/cpu/idt.c</code></a></li>
<li><a href="https://github.com/thebenos/benos/blob/main/kernel/asm/idt_flush.asm"><code>kernel/asm/idt_flush.asm</code></a></li>
<li><a href="https://github.com/thebenos/benos/blob/main/kernel/cpu/include/interrupts.h"><code>kernel/cpu/include/interrupts.h</code></a></li>
<li><a href="https://github.com/thebenos/benos/blob/main/kernel/cpu/interrupts.c"><code>kernel/cpu/interrupts.c</code></a></li>
<li><a href="https://github.com/thebenos/benos/blob/main/kernel/cpu/isr.asm"><code>kernel/cpu/isr.asm</code></a></li>
</ul>
<hr />
<h2 id="responsibilities">Responsibilities</h2>
<p>The IDT code is responsible for:</p>
<ul>
<li>Defining and populating the IDT entries</li>
<li>Initializing exception handlers (0–31)</li>
<li>Initializing hardware interrupt handlers (32–47)</li>
<li>Loading the IDT</li>
</ul>
<hr />
<p><em>NOTE: Actually, the exception handlers and hardware interrupt handlers are not complete. The IDT can handle:</em></p>
<p><em>- General Protection Fault (#GP)</em></p>
<p><em>- Page Fault (#PF)</em></p>
<p><em>- Double Fault (#DF)</em></p>
<p><em>- Division Error (#DE)</em></p>
<p><em>- Invalid TSS (#TS)</em></p>
<p><em>- IRQ 0 (PIT)</em></p>
<p><em>- IRQ 1 (Keyboard)</em></p>
<hr />
<hr />
<h2 id="initialization-flow">Initialization flow</h2>
<h3 id="1-idt-structures">1. IDT structures</h3>
<p>The IDT is defined as a static array of descriptors in <code>kernel/cpu/include/idt.h</code>. A pointer structure named <code>idt_ptr_t</code> is passed to <code>lidt</code> to load it in <code>kernel/asm/idt_flush.asm</code>.</p>
<pre><code class="language-c">// Source: kernel/cpu/include/idt.h

// The IDT descriptor structure
typedef struct
{
    uint16_t offset_low;
    uint16_t selector;
    uint8_t ist;
    uint8_t type_attribute;
    uint16_t offset_middle;
    uint32_t offset_high;
    uint32_t zero;
} __attribute__ ((packed)) idt_entry_t;

// The IDT pointer structure
typedef struct
{
    uint16_t limit;
    uint64_t base;
} __attribute__ ((packed)) idt_ptr_t;
</code></pre>
<hr />
<h3 id="2-initialization-function">2. Initialization function</h3>
<p><em>NOTE: the functions described below depend of the <code>idt</code> array.</em></p>
<p>The IDT is initialized using the <code>idt_init()</code> function declared in <code>kernel/cpu/include/idt.h</code>. This function is defined in <code>kernel/cpu/idt.c</code>. First, it sets up the IDT pointer (defined as <code>idt_ptr</code>) and then, it sets up the IDT entries with the <code>idt_set_entry()</code> function defined in <code>kernel/cpu/include/idt.h</code> like the following:</p>
<pre><code class="language-c">// Source: kernel/cpu/include/idt.h

void idt_set_entry(int n, uint64_t base, uint16_t selector, uint8_t flags);
</code></pre>
<p>After setting up all the IDT entries, <code>idt_init()</code> flushes the IDT using <code>idt_flush()</code> defined in <code>kernel/asm/idt_flush.asm</code>.</p>
<pre><code class="language-nasm">; Source: kernel/asm/idt_flush.asm

idt_flush:
    mov rax, rdi
    lidt [rax]
    ret
</code></pre></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
